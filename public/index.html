<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Extraction Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .drag-over {
            border-color: #667eea !important;
            background-color: rgba(102, 126, 234, 0.1) !important;
        }
        
        #pdf-canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-white text-center">Invoice Extraction Tool</h1>
            <p class="text-purple-100 text-center mt-2">Upload your invoice for intelligent data extraction</p>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="upload-section" class="glass-effect rounded-xl shadow-lg p-6 mb-6">
            <div class="max-w-xl mx-auto">
                <label for="file-upload" class="block">
                    <div id="drop-zone" class="border-2 border-dashed border-purple-300 rounded-lg p-8 text-center hover:border-purple-400 cursor-pointer transition-colors">
                        <svg class="mx-auto h-12 w-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-semibold text-purple-600">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500 mt-1">PDF files only (up to 50MB)</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept=".pdf" />
                </label>
            </div>
        </div>

        <div id="processing-status" class="hidden glass-effect rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center space-x-3">
                <div class="animate-spin">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">Processing Invoice</h3>
                    <p id="processing-message" class="text-sm text-gray-600">Extracting data from your invoice...</p>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-xs text-gray-500 mt-1">0% complete</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Document Preview</h2>
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" class="p-2 text-gray-600 hover:text-purple-600 disabled:opacity-50" disabled>
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span id="page-info" class="text-sm text-gray-600">Page 1 of 1</span>
                            <button id="next-page" class="p-2 text-gray-600 hover:text-purple-600 disabled:opacity-50" disabled>
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="pdf-container" class="overflow-auto max-h-[600px] border border-gray-200 rounded-lg bg-gray-50 p-4">
                        <canvas id="pdf-canvas" class="mx-auto"></canvas>
                    </div>
                </div>

                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Extracted Data</h2>
                        <button id="clear-process" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                            Clear & Process Next
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                                <input type="text" id="invoice-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="N/A">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date</label>
                                <input type="date" id="invoice-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label>
                                <input type="text" id="vendor-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="N/A">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount</label>
                                <input type="text" id="total-amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0.00">
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Line Items</h3>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="line-items" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                </table>
                                <div class="px-4 py-2 bg-gray-50">
                                    <button id="add-line-item" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                                        + Add Line Item
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-3 pt-4">
                            <button id="save-data" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700">
                                Save Invoice Data
                            </button>
                            <button id="export-csv" class="flex-1 border border-purple-600 text-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-purple-50">
                                Export to CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

    <script>
        // --- IMPORTANT: OLLAMA SETUP ---
        // This tool requires a locally running Ollama instance.
        // Make sure Ollama is running and you have a model like 'phi3' or 'qwen3:4b' pulled.
        // By default, it will try to connect to http://localhost:11434.

        const OLLAMA_API_URL = "http://localhost:11434/api/generate";
        const OLLAMA_MODEL = "qwen3:4b";

        // --- PROMPT TEMPLATE FOR THE AI ---

        const PROMPT_TEMPLATE = `
        You are an expert invoice data extraction AI. Your task is to extract structured data from OCR text.
        
        CRITICAL INSTRUCTIONS:
        - Analyze the text and extract the information based on the requested JSON format.
        - Be aggressive in finding values; prefer educated guesses over returning null.
        - If a value is genuinely not present, use null.
        - Return ONLY a valid JSON object without any other text, explanation, or commentary.
        
        TARGET JSON FORMAT:
        {
          "vendor_name": "string or null",
          "invoice_number": "string or null",
          "invoice_date": "string in YYYY-MM-DD format or null",
          "total_amount": "number or null",
          "line_items": [
            { "description": "string", "amount": "number or null" }
          ]
        }
        
        INVOICE TEXT TO ANALYZE:
        ---
        {{invoiceText}}
        ---
        
        RESPOND WITH ONLY THE JSON OBJECT:`;

        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        }

        // --- APP STATE AND ELEMENTS ---
        let currentPDF = null;
        let currentPage = 1;
        let totalPages = 0;
        let extractedData = null;

        const fileUpload = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const uploadSection = document.getElementById('upload-section');
        const processingStatus = document.getElementById('processing-status');
        const processingMessage = document.getElementById('processing-message');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const mainContent = document.getElementById('main-content');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pageInfo = document.getElementById('page-info');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const clearProcessBtn = document.getElementById('clear-process');
        const saveDataBtn = document.getElementById('save-data');
        const exportCsvBtn = document.getElementById('export-csv');
        const addLineItemBtn = document.getElementById('add-line-item');
        const lineItemsTable = document.getElementById('line-items');

        function updateProgress(percent, message = '') {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}% complete`;
            if (message) {
                processingMessage.textContent = message;
            }
        }

        async function handleFile(file) {
            if (typeof pdfjsLib === 'undefined' || typeof Tesseract === 'undefined') {
                alert('A required library (PDF.js or Tesseract.js) has not loaded. Please check your internet connection and refresh.');
                return;
            }

            uploadSection.classList.add('hidden');
            processingStatus.classList.remove('hidden');
            mainContent.classList.add('hidden');
            updateProgress(0, 'Starting process...');

            try {
                updateProgress(10, 'Reading file...');
                const arrayBuffer = await file.arrayBuffer();
                
                updateProgress(25, 'Loading PDF document...');
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                currentPDF = pdf;
                totalPages = pdf.numPages;
                
                updateProgress(40, 'Rendering document preview...');
                await renderPage(1);
                
                updateProgress(50, 'Extracting text from document...');
                await extractAndProcessText(pdf);
                
                updateProgress(100, 'Extraction complete!');
                
                setTimeout(() => {
                    processingStatus.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    updateUI();
                }, 500);
                
            } catch (error) {
                console.error('Error during file handling:', error);
                alert('An error occurred: ' + error.message);
                resetApp();
            }
        }

        async function renderPage(pageNum) {
            if (!currentPDF) return;
            const page = await currentPDF.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            const context = pdfCanvas.getContext('2d');
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            pageInfo.textContent = `Page ${pageNum} of ${totalPages}`;
            prevPageBtn.disabled = pageNum <= 1;
            nextPageBtn.disabled = pageNum >= totalPages;
            currentPage = pageNum;
        }

        async function extractAndProcessText(pdf) {
            let fullText = '';
            
            updateProgress(55, 'Phase 1: Attempting direct text extraction...');
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
            }
            
            if (fullText.trim().length < 100) {
                updateProgress(65, 'Phase 2: Direct extraction insufficient. Running OCR...');
                fullText = await doOCR(pdf, 1); 
            }
            
            updateProgress(80, 'Phase 3: Sending text to AI for analysis...');
            extractedData = await queryOllama(fullText);
            console.log('AI Response:', extractedData);
        }

        // Perform OCR on a single PDF page
        async function doOCR(pdf, pageNum) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 2.0 });
            
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            const context = canvas.getContext('2d');
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            const worker = await Tesseract.createWorker('eng');
            const { data: { text } } = await worker.recognize(canvas);
            await worker.terminate();
            
            return text;
        }

        async function queryOllama(text) {


            console.log(text)

            const prompt = PROMPT_TEMPLATE.replace('{{invoiceText}}', text);

            try {
                const response = await fetch(OLLAMA_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: OLLAMA_MODEL,
                        prompt: prompt,
                        format: 'json',
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`Ollama API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                return JSON.parse(data.response);

            } catch (error) {
                console.error("Could not connect to Ollama.", error);
                alert("Failed to connect to the local AI model. Please ensure Ollama is running and accessible.");
                throw error;
            }
        }

        function updateUI() {
            if (!extractedData) return;

            document.getElementById('invoice-number').value = extractedData.invoice_number || '';
            document.getElementById('invoice-date').value = extractedData.invoice_date || '';
            document.getElementById('vendor-name').value = extractedData.vendor_name || '';
            document.getElementById('total-amount').value = extractedData.total_amount || '';
            
            lineItemsTable.innerHTML = ''; // Clear existing line items
            if (extractedData.line_items && extractedData.line_items.length > 0) {
                extractedData.line_items.forEach(item => {
                    addLineItemRow(item.description, item.amount);
                });
            } else {
                addLineItemRow();
            }
        }

        // Add a row to the line items table
        function addLineItemRow(description = '', amount = '') {
            const row = lineItemsTable.insertRow();
            row.innerHTML = `
                <td class="px-4 py-2">
                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                           placeholder="Item description" value="${description}">
                </td>
                <td class="px-4 py-2">
                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded text-right" 
                           placeholder="0.00" value="${amount}">
                </td>
                <td class="px-4 py-2 text-center">
                    <button class="text-red-600 hover:text-red-800" onclick="this.closest('tr').remove()">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </td>
            `;
        }

        function resetApp() {
            currentPDF = null;
            currentPage = 1;
            totalPages = 0;
            extractedData = null;
            
            mainContent.classList.add('hidden');
            processingStatus.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            fileUpload.value = '';
            
            const context = pdfCanvas.getContext('2d');
            context.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
        }


        fileUpload.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });

        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) renderPage(currentPage - 1); });
        nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) renderPage(currentPage + 1); });
        addLineItemBtn.addEventListener('click', () => addLineItemRow());
        clearProcessBtn.addEventListener('click', resetApp);

        saveDataBtn.addEventListener('click', () => {
            alert('Data "saved"! (Feature to be implemented)');
        });

        exportCsvBtn.addEventListener('click', () => {
            if (!extractedData) {
                alert('No data to export.');
                return;
            }
            const headers = "Invoice Number,Date,Vendor,Amount\n";
            const row = `"${extractedData.invoice_number}","${extractedData.invoice_date}","${extractedData.vendor_name}","${extractedData.total_amount}"`;
            const csv = headers + row;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoice_${extractedData.invoice_number || 'data'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        console.log('ðŸš€ Invoice Extraction Tool with AI is ready!');
    </script>
</body>
</html>