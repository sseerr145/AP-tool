<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Extraction Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .drag-over {
            border-color: #667eea !important;
            background-color: rgba(102, 126, 234, 0.1) !important;
        }
        
        #pdf-canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-white text-center">Invoice Extraction Tool</h1>
            <p class="text-purple-100 text-center mt-2">Upload your invoice for intelligent data extraction</p>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Upload Section -->
        <div class="glass-effect rounded-xl shadow-lg p-6 mb-6">
            <div class="max-w-xl mx-auto">
                <label for="file-upload" class="block">
                    <div id="drop-zone" class="border-2 border-dashed border-purple-300 rounded-lg p-8 text-center hover:border-purple-400 cursor-pointer transition-colors">
                        <svg class="mx-auto h-12 w-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-semibold text-purple-600">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500 mt-1">PDF files only (up to 50MB)</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept=".pdf" />
                </label>
            </div>
        </div>

        <!-- Processing Status -->
        <div id="processing-status" class="hidden glass-effect rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center space-x-3">
                <div class="animate-spin">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">Processing Invoice</h3>
                    <p id="processing-message" class="text-sm text-gray-600">Extracting data from your invoice...</p>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-xs text-gray-500 mt-1">0% complete</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- PDF Preview (Left) -->
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Document Preview</h2>
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" class="p-2 text-gray-600 hover:text-purple-600 disabled:opacity-50" disabled>
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span id="page-info" class="text-sm text-gray-600">Page 1 of 1</span>
                            <button id="next-page" class="p-2 text-gray-600 hover:text-purple-600 disabled:opacity-50" disabled>
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="pdf-container" class="overflow-auto max-h-[600px] border border-gray-200 rounded-lg bg-gray-50 p-4">
                        <canvas id="pdf-canvas" class="mx-auto"></canvas>
                    </div>
                </div>

                <!-- Extracted Data (Right) -->
                <div class="glass-effect rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Extracted Data</h2>
                        <button id="clear-process" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                            Clear & Process Next
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Invoice Details Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                                <input type="text" id="invoice-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="INV-001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date</label>
                                <input type="date" id="invoice-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label>
                                <input type="text" id="vendor-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Company Name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount</label>
                                <input type="text" id="total-amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="$0.00">
                            </div>
                        </div>

                        <!-- Line Items -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Line Items</h3>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="line-items" class="bg-white divide-y divide-gray-200">
                                        <!-- Line items will be added here -->
                                    </tbody>
                                </table>
                                <div class="px-4 py-2 bg-gray-50">
                                    <button id="add-line-item" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                                        + Add Line Item
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3 pt-4">
                            <button id="save-data" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700">
                                Save Invoice Data
                            </button>
                            <button id="export-csv" class="flex-1 border border-purple-600 text-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-purple-50">
                                Export to CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load libraries from different CDN -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

    <script>
        console.log('🚀 Script starting...');
        
        // Check if libraries loaded
        console.log('📚 Checking libraries:');
        console.log('- pdfjsLib:', typeof pdfjsLib !== 'undefined' ? '✅ LOADED' : '❌ MISSING');
        console.log('- Tesseract:', typeof Tesseract !== 'undefined' ? '✅ LOADED' : '❌ MISSING');
        
        // Configure PDF.js immediately
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            console.log('✅ PDF.js configured');
        } else {
            console.error('❌ PDF.js not loaded!');
        }

        // Simple app state
        let currentPDF = null;
        let currentPage = 1;
        let totalPages = 0;
        let extractedData = {
            invoiceNumber: '',
            invoiceDate: '',
            vendorName: '',
            totalAmount: '',
            lineItems: []
        };

        // Get elements
        const fileUpload = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const processingStatus = document.getElementById('processing-status');
        const processingMessage = document.getElementById('processing-message');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const mainContent = document.getElementById('main-content');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pageInfo = document.getElementById('page-info');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const clearProcessBtn = document.getElementById('clear-process');
        const saveDataBtn = document.getElementById('save-data');
        const exportCsvBtn = document.getElementById('export-csv');
        const addLineItemBtn = document.getElementById('add-line-item');
        const lineItemsTable = document.getElementById('line-items');

        // Update progress
        function updateProgress(percent, message = '') {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}% complete`;
            if (message) {
                processingMessage.textContent = message;
            }
        }

        // File upload
        console.log('🔧 Setting up file upload event listeners...');
        fileUpload.addEventListener('change', function(event) {
            console.log('📁 File input changed!', event.target.files);
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                console.log('✅ Valid PDF file selected:', file.name);
                handleFile(file);
            } else {
                console.error('❌ Invalid file type:', file ? file.type : 'no file');
                alert('Please select a PDF file');
            }
        });

        // Drag and drop
        console.log('🎯 Setting up drag & drop event listeners...');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
            console.log('📥 Drag over');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            console.log('📤 Drag leave');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            console.log('📂 File dropped!', e.dataTransfer.files);
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                console.log('✅ Valid PDF dropped:', files[0].name);
                handleFile(files[0]);
            } else {
                console.error('❌ Invalid file dropped:', files[0] ? files[0].type : 'no file');
                alert('Please drop a PDF file');
            }
        });

        // Handle file processing
        async function handleFile(file) {
            console.log('🔄 Starting handleFile with:', file.name, file.size, 'bytes');
            
            // Check if libraries are available
            if (typeof pdfjsLib === 'undefined') {
                console.error('❌ PDF.js not available!');
                alert('PDF.js library not loaded. Please refresh and try again.');
                return;
            }
            
            // Show processing
            console.log('📊 Showing processing UI...');
            processingStatus.classList.remove('hidden');
            mainContent.classList.add('hidden');
            updateProgress(0, 'Loading PDF...');

            try {
                // Load PDF
                console.log('📖 Reading file as ArrayBuffer...');
                updateProgress(20, 'Reading file...');
                const arrayBuffer = await file.arrayBuffer();
                console.log('✅ ArrayBuffer created:', arrayBuffer.byteLength, 'bytes');
                
                console.log('🔧 Loading PDF with PDF.js...');
                updateProgress(40, 'Loading PDF...');
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                currentPDF = pdf;
                totalPages = pdf.numPages;
                console.log('PDF loaded with', totalPages, 'pages');
                
                // Render first page
                updateProgress(60, 'Rendering preview...');
                await renderPage(1);
                
                // Extract text
                updateProgress(80, 'Extracting text...');
                await extractText(pdf);
                
                updateProgress(100, 'Complete!');
                
                // Show results
                setTimeout(() => {
                    processingStatus.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    updateUI();
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing PDF: ' + error.message);
                processingStatus.classList.add('hidden');
            }
        }

        // Render PDF page
        async function renderPage(pageNum) {
            if (!currentPDF) return;
            
            const page = await currentPDF.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            const canvas = pdfCanvas;
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            // Update page info
            pageInfo.textContent = `Page ${pageNum} of ${totalPages}`;
            prevPageBtn.disabled = pageNum <= 1;
            nextPageBtn.disabled = pageNum >= totalPages;
            currentPage = pageNum;
            
            console.log('Rendered page', pageNum);
        }

        // Extract text from PDF
        async function extractText(pdf) {
            let fullText = '';
            
            // Try text extraction first
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            
            console.log('Extracted text length:', fullText.length);
            
            // If no text, try OCR
            if (fullText.trim().length < 50) {
                console.log('Low text content, trying OCR...');
                updateProgress(85, 'Running OCR...');
                fullText = await doOCR(pdf);
            }
            
            // Parse the text
            extractedData = parseText(fullText);
            console.log('Parsed data:', extractedData);
        }

        // OCR function
        async function doOCR(pdf) {
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 2 });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;
            
            const worker = await Tesseract.createWorker('eng');
            const { data: { text } } = await worker.recognize(canvas);
            await worker.terminate();
            
            return text;
        }

        // Parse text for invoice data
        function parseText(text) {
            const data = {
                invoiceNumber: '',
                invoiceDate: '',
                vendorName: '',
                totalAmount: '',
                lineItems: []
            };

            const lines = text.split('\n').filter(line => line.trim());
            
            // Find invoice number (your format: 561DSSBM-0002)
            const invoiceMatch = text.match(/([0-9]{3,}[A-Z]{2,}[A-Z0-9\-]{0,})/i) ||
                               text.match(/invoice\s*#?\s*:?\s*([A-Z0-9\-]+)/i) ||
                               text.match(/#\s*([A-Z0-9\-]{3,})/i);
            if (invoiceMatch) {
                data.invoiceNumber = invoiceMatch[1];
            }
            
            // Find date
            const dateMatch = text.match(/(january|february|march|april|may|june|july|august|september|october|november|december)\s+\d{1,2},?\s+\d{4}/i) ||
                            text.match(/(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/);
            if (dateMatch) {
                const date = new Date(dateMatch[1]);
                if (!isNaN(date)) {
                    data.invoiceDate = date.toISOString().split('T')[0];
                }
            }
            
            // Find vendor (first few lines, look for company names)
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i];
                if (line.length > 3 && line.length < 50 && 
                    !line.match(/invoice|date|total/i) &&
                    (line.match(/inc\.|corp\.|ltd\.|llc/i) || line.match(/^[A-Z][a-z\s]+$/))) {
                    data.vendorName = line;
                    break;
                }
            }
            
            // Find total amount
            const totalMatch = text.match(/total\s*:?\s*\$?\s*([\d,]+\.?\d*)/i) ||
                             text.match(/amount\s*due\s*:?\s*\$?\s*([\d,]+\.?\d*)/i) ||
                             text.match(/\$\s*([\d,]+\.?\d{2})/);
            if (totalMatch) {
                data.totalAmount = '$' + totalMatch[1].replace(/,/g, '');
            }
            
            // Add a default line item
            data.lineItems = [{ description: '', amount: '' }];
            
            return data;
        }

        // Update UI with extracted data
        function updateUI() {
            document.getElementById('invoice-number').value = extractedData.invoiceNumber || '';
            document.getElementById('invoice-date').value = extractedData.invoiceDate || '';
            document.getElementById('vendor-name').value = extractedData.vendorName || '';
            document.getElementById('total-amount').value = extractedData.totalAmount || '';
            
            // Add line items
            lineItemsTable.innerHTML = '';
            extractedData.lineItems.forEach((item, index) => {
                addLineItemRow(item.description, item.amount, index);
            });
        }

        // Add line item row
        function addLineItemRow(description = '', amount = '', index = null) {
            const row = document.createElement('tr');
            const itemIndex = index !== null ? index : extractedData.lineItems.length;
            
            row.innerHTML = `
                <td class="px-4 py-2">
                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded" 
                           placeholder="Item description" value="${description}">
                </td>
                <td class="px-4 py-2">
                    <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded text-right" 
                           placeholder="$0.00" value="${amount}">
                </td>
                <td class="px-4 py-2 text-center">
                    <button class="text-red-600 hover:text-red-800" onclick="this.closest('tr').remove()">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </td>
            `;
            
            lineItemsTable.appendChild(row);
        }

        // Page navigation
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) renderPage(currentPage - 1);
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) renderPage(currentPage + 1);
        });

        // Add line item
        addLineItemBtn.addEventListener('click', () => {
            addLineItemRow();
        });

        // Save data
        saveDataBtn.addEventListener('click', () => {
            console.log('Saving data...');
            alert('Invoice data saved!');
        });

        // Export CSV
        exportCsvBtn.addEventListener('click', () => {
            const csv = `Invoice Number,Date,Vendor,Amount\n"${extractedData.invoiceNumber}","${extractedData.invoiceDate}","${extractedData.vendorName}","${extractedData.totalAmount}"`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invoice.csv';
            a.click();
        });

        // Clear and reset
        clearProcessBtn.addEventListener('click', () => {
            currentPDF = null;
            currentPage = 1;
            totalPages = 0;
            extractedData = { invoiceNumber: '', invoiceDate: '', vendorName: '', totalAmount: '', lineItems: [] };
            
            mainContent.classList.add('hidden');
            fileUpload.value = '';
            
            const context = pdfCanvas.getContext('2d');
            context.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
        });

        // Final status check
        console.log('🎯 Checking if all elements found:');
        console.log('- fileUpload:', fileUpload ? '✅' : '❌');
        console.log('- dropZone:', dropZone ? '✅' : '❌');
        console.log('- processingStatus:', processingStatus ? '✅' : '❌');
        console.log('- mainContent:', mainContent ? '✅' : '❌');
        console.log('- pdfCanvas:', pdfCanvas ? '✅' : '❌');
        
        console.log('🚀 Invoice Extraction Tool ready!');
    </script>
</body>
</html>